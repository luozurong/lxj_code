<%
	String basePath = request.getScheme() + "://" + request.getServerName() + ":" + request.getServerPort() + request.getContextPath();
%>
<%@ page language="java" pageEncoding="UTF-8"%>
<%@ page language="java" import="java.util.*" %>
<%@ page language="java" import="com.hori.vo.*" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<!DOCTYPE html>
<html style="height: 100%;">
	<head>
	<meta charset="UTF-8">
	<title>查看项目</title>
	<meta http-equiv="X-UA-Compatible" content="edge" />
    <link rel="stylesheet" type="text/css" href="<%=basePath%>/common/easyui/themes/default/easyui.css" />
    <link rel="stylesheet" type="text/css" href="<%=basePath%>/common/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="<%=basePath%>/common/css/common.css" />
    <link rel="stylesheet" type="text/css" href="<%=basePath%>/project/css/project.css" />
    <script src="<%=basePath%>/common/easyui/jquery.min.js"></script>
    <script src="<%=basePath%>/common/easyui/jquery.easyui.min.js"></script>
    <link rel="shortcut icon" href="<%=basePath%>/homepage/images/ywhlzt.ico" type="image/x-icon">
	    <link rel="stylesheet" type="text/css" href="<%=basePath%>/homepage/css/index.css"/>
	    <style type="text/css">
	    	.wrap{
	    		margin: 20px;
	    	}
	    	.body-box{
	    		margin-left: 50px;
	    	}
	    	.table-wrap{
	    		width: 100%;
	    		overflow: hidden;
	    	}
	    	.table-wrap>div{
	    		width: 30%;
	    		float: left;
	    		line-height: 50px;
	    	}
	    	.table-wrap>div.table-width{
	    		width: 50%;
	    	}
	    	.table-wrap-three{
	    		overflow:hidden;
	    		margin-top:50px;
	    	}
	    	.table-wrap-three span{
	    		float:left;
	    		line-height: 50px;
	    	}
	    	.table-wrap-three>div{
	    		float: left;
	    		line-height:50px;
	    		width:70%;
	    	}
	    	.line-borders:last-child{
	    		border-bottom:none;
	    	}
	    	
	    	.projectProductList_Box .datagrid-row-checked{
	    	  background-color:#fff!important;
	    	}
	    </style>	
	    
	<script type="text/javascript">
		//填充资源清单表格
		function getResourceView(sss,$eleS){
			var list1 = [];
			var list2 = [];
			var list3 = [];
			var dataList = [];
			var si = 0;
			for(var i = 0; i < sss.length; i++) {
				for(var j = 0; j < sss[i].projectMenus.length; j++) {
					if(sss[i].projectMenus.length > 1 && j == 0) {
						if(sss[i].businessName == "社区运营") {//社区运营和其他类型合并规则区分
							list1.push({
								index: si,
								rowspan: sss[i].projectMenus.length
							});
							list2.push({
								index: si,
								rowspan: sss[i].projectMenus.length
							});
							list3.push({
								index: si,
								rowspan: sss[i].projectMenus.length
							});
						} else {
							list2.push({
								index: si,
								rowspan: sss[i].projectMenus.length
							});
						}
					}
					si++;
					dataList.push({
						fieldName: sss[i].fieldName,
						businessName: sss[i].businessName,
						businessType: sss[i].businessType,
						productType: sss[i].projectMenus[j].productType,
						productMenu: sss[i].projectMenus[j].productMenu,
						productSpec: sss[i].projectMenus[j].productSpec,
						areaNames: sss[i].projectMenus[j].areaNames,
						beginTime: sss[i].projectMenus[j].beginTime,
						endTime: sss[i].projectMenus[j].endTime,
						buyNum: sss[i].projectMenus[j].buyNum
					})
				}
			}
			$eleS.datagrid({
				data: dataList,
				fitColumns: true,
				nowrap: false,
				scrollbarSize: 0,
				onLoadSuccess: function(data) {
					$(".datagrid-cell-check").addClass('dataCheck');
					$(".datagrid-header-check").addClass('dataCheck');
					for(var a = 0; a < list1.length; a++) {
						$eleS.datagrid('mergeCells', { //第一列合并
							index: list1[a].index,
							field: 'fieldName',
							rowspan: list1[a].rowspan
						});
					}
					for(var b = 0; b < list2.length; b++) {
						$eleS.datagrid('mergeCells', { //第一列合并
							index: list2[b].index,
							field: 'businessName',
							rowspan: list2[b].rowspan
						});
					}
					for(var c = 0; c < list3.length; c++) {
						$eleS.datagrid('mergeCells', { //第一列合并
							index: list3[c].index,
							field: 'areaNames',
							rowspan: list3[c].rowspan
						});
					}
					$eleS.parent().find('td[field=areaNames] .datagrid-cell').each(function() {
						$(this).attr('title', $(this).html());
					});
					setTimeout(function(){
						$eleS.datagrid('resize');
					},30)
				},
				columns: [
					[ //相应调整显示栏
						{
							field: 'fieldName',
							title: '场次名称',
							width: 100,
							align: "center"
						},
						{
							field: 'businessName',
							title: '业务',
							width: 110,
							align: "center"
						},
						{
							field: 'productType',
							title: '类型',
							width: 100,
							align: "center"
						},
						{
							field: 'productMenu',
							title: '产品清单',
							width: 80,
							align: "center"
						},
						{
							field: 'productSpec',
							title: '产品规格',
							width: 80,
							align: "center"
						},
						{
							field: 'buyNum',
							title: '购买数量',
							width: 80,
							align: "center"
						},
						{
							field: 'beginTime',
							title: '执行开始时间',
							width: 120,
							align: "center",
							formatter: function(value,row,index){
								if(row.businessType=='1'){
									return value;
								}else{
									return value.substr(0,11);
								}	
							}
						},
						{
							field: 'endTime',
							title: '执行结束时间',
							width: 120,
							align: "center",
							formatter: function(value,row,index){
								if(row.businessType=='1'){
									return value;
								}else{
									return value.substr(0,11);
								}	
							}
						},
						{
							field: 'areaNames',
							title: '已选小区',
							width: 230,
							align: "center"
						}
					]
				]
			});
		}
		
		//下载资源清单列表
		function download(){
			$.messager.confirm('下载', '是否下载资源清单?', function(r){
				if (r){
		         location.href="<%=basePath%>/project/exportDetail?projectCode=${projectVo.projectCode}"
				}
			});
		}
		
		//填充执行清单表格
		function getProjectAction(sss,$eleS){
			var list1 = [];
			var list2 = [];
			var list3 = [];
			var dataList = [];
			for(var i = 0; i < sss.length; i++) {
				dataList.push({
					beginTime: sss[i].beginTime,
					areaName: sss[i].areaName,
					provinceName: sss[i].provinceName,
					cityName: sss[i].cityName,
					countryName: sss[i].countryName,
					areaAddress: sss[i].areaAddress,
					businessType: sss[i].businessType,
					projectName: sss[i].projectName,
					fieldName: sss[i].fieldName,
					actionStatus: sss[i].actionStatus,
					exceptionStatus: sss[i].exceptionStatus,
					projectProductId: sss[i].projectProductId
				})
			}
			$eleS.datagrid({
				data: dataList,
				fitColumns: true,
				nowrap: false,
				scrollbarSize: 0,
				onLoadSuccess: function(data) {
					$(".datagrid-cell-check").addClass('dataCheck');
					$(".datagrid-header-check").addClass('dataCheck');
					$eleS.parent().find('td[field=projectProductId] .datagrid-cell').each(function() {
						$(this).attr('title', $(this).html());
					});
					setTimeout(function(){
						$eleS.datagrid('resize');
					},30)
				},
				columns: [
					[ //相应调整显示栏
						{
							field: 'beginTime',
							title: '执行日期',
							width: 100,
							align: "center"
						},
						{
							field: 'areaName',
							title: '小区名称',
							width: 80,
							align: "center"
						},
						{
							field: 'provinceName',
							title: '省份',
							width: 80,
							align: "center"
						},
						{
							field: 'cityName',
							title: '城市',
							width: 80,
							align: "center"
						},
						{
							field: 'countryName',
							title: '区（县）',
							width: 80,
							align: "center"
						},
						{
							field: 'areaAddress',
							title: '详细地址',
							width: 100,
							align: "center"
						},
						{
							field: 'businessType',
							title: '执行组织',
							width: 80,
							align: "center",
							formatter: function(value,row,index){
								if(row.businessType=='1'){
									return "社区运营";
								}else if(row.businessType=='2'){
									return "媒管";
								}else if(row.businessType=='3'){
									return "用户运营";
								}else if(row.businessType=='4'){
									return "电商运营";
								};		
							}
						},
						{
							field: 'projectName',
							title: '项目名称',
							width: 80,
							align: "center"
						},
						{
							field: 'fieldName',
							title: '场次名称',
							width: 80,
							align: "center"
						},
						{
							field: 'actionStatus',
							title: '执行状态',
							width: 80,
							align: "center",
							formatter: function(value,row,index){
								if(row.actionStatus=='1'){
									return "待确认";
								}else if(row.actionStatus=='2'){
									return "策划中";
								}else if(row.actionStatus=='3'){
									return "待执行";
								}else if(row.actionStatus=='4'){
									return "执行中";
								}else if(row.actionStatus=='5'){
									return "已完成";
								}
							}
						},
						{
							field: 'exceptionStatus',
							title: '是否异常',
							width: 80,
							align: "center",
							formatter: function(value,row,index){
								if(row.exceptionStatus=='1'){
									return "正常";
								}else {
									return "异常";
								}	
							}
						},
						{
							field: 'projectProductId',
							title: '操作',
							width: 80,
							align: "center",
							formatter: function(value,row,index){
								var _htmlbt='<a href="javascript:;" data-id="1" style="color: #0066FF">活动详情</a>';
								return _htmlbt;
							}
						}
					]
				]
			});
		}
		
		
		
		$(function(){
			var sss = ${projectProductListStr};
			var ddd = ${projectActionListStr};
	        getResourceView(sss,$('#projectProductList'));
	        getProjectAction(ddd,$('#projectActionList'));
	     });       

	</script>    
	</head>
	<body >
		<div class="wrap">
			<div class="topTitle clearfix">
					<div class="path1 fl">项目管理</div>
					<div class="path2 fl">查看项目</div>
			</div>
			
			<div class="blackbackground">
				<div style="background-color:rgba(102, 102, 102, 1);width:100%;height:44px;float: left;margin:20px 0px 20px 0px" >
					<div style="color: #FFFFFF;border-style:solid; border-width:10px; border-color:rgba(102, 102, 102, 1)" >
						<span >查看项目信息</span>
					</div>
				</div>
			</div>
			<div class="body-box">
				<div class="table-wrap">
					<div>
						<span>项目名称：</span>
						<span>${ projectVo.name}</span>	
					</div>	
					<div>
						<span>项目ID：</span>
						<span>${ projectVo.id}</span>	
					</div>
					<div>
						<span>项目进度：</span>
						<span>
						<c:if test="${projectVo.status == 0}">待审核</c:if>
						<c:if test="${projectVo.status == 1}">审核通过</c:if>
						<c:if test="${projectVo.status == 2}">审核不通过</c:if>
						<c:if test="${projectVo.status == 3}">立项终止</c:if>
						<c:if test="${projectVo.status == 4}">撤回</c:if>
						</span>	
					</div>
					<div>
						<span>客户信息：</span>
						<span>${projectVo.customerName}</span>	
					</div>
					<div class="table-width">
						<span>客户ID：</span>
						<span>${projectVo.customerId}</span>	
					</div>
					<c:if test="${projectVo.contractStatus == 7}">
						<div>
							<span>合同名称：</span>
							<span>${projectVo.contractName}</span>	
						</div>
						<div class="table-width">
							<span>合同ID：</span>
							<span>${projectVo.customerId}</span>	
						</div >
					</c:if>
					<c:forEach items="${projectVo.roles}" var="r"> 
						<div>
							<span>项目角色：</span>
							<span>${r.projectRoleName}</span>	
						</div>	
						<div>
							<span>联系人名称：</span>
							<span>${r.name}<</span>	
						</div>
						<div>
							<span>联系电话：</span>
							<span>${r.phone}</span>	
						</div>
					</c:forEach>
				</div>	
				<div class="table-wrap-three">
					<span>项目说明：</span>
					<div style="margin: 2px">${projectVo.description}</div>	
				</div>
			</div>
			
			<div class="blackbackground">
				<div style="background-color:rgba(102, 102, 102, 1);width:100%;height:44px;float: left;margin:20px 0px 20px 0px" >
					<div style="color: #FFFFFF;border-style:solid; border-width:10px; border-color:rgba(102, 102, 102, 1)" >
						<span >查看资料清单</span>
					</div>
				</div>
			</div>
			<div style="background-color: rgba(22, 155, 213, 1);height: 40px;float: right;border-radius:5px;margin: 20px" >
				<div style="visibility: visible;margin:10px;color: #FFFFFF" onclick="download()">
					<a href="javascript:;"   style="color: #FFFFFF">资源清单下载</a> 
				</div>
			</div>
			
			<div class="projectProductList_Box" style="margin: 20px;width:100%;">
				<div id="projectProductList"  style='width:97%'></div>
			</div>
			
			<div id="attachmentList_Box" style="margin:20px;width:60%;">
				<c:if test="${fn:length(attachmentList) > 0}">
					<div  style='width:40%;float:left;text-align: center;line-height:30px;border:1px solid #d6d6d6;background-color: #eaf2ff '>附件名称</div>
					<div  style='width:40%;float:left;text-align: center;line-height:30px;border:1px solid #d6d6d6;background-color: #eaf2ff '>操作</div>
				</c:if>
				<c:forEach items="${attachmentList}" var="r"> 
						<div  style='width:40%;float:left;text-align: center;line-height:30px;border:1px solid #ccc;'>${r.fileName} </div>
						<div  style='width:40%;float:left;text-align: center;line-height:30px;border:1px solid #ccc;'>
							<a href="${fileUrl}" style="color: #0066FF">下载</a>
						</div>
				</c:forEach>
			</div>
			
			<div class="blackbackground">
				<div style="background-color:rgba(102, 102, 102, 1);width:100%;height:44px;float: left;margin:20px 0px 20px 0px" >
					<div style="color: #FFFFFF;border-style:solid; border-width:10px; border-color:rgba(102, 102, 102, 1)" >
						<span >查看执行清单</span>
					</div>
				</div>
			</div>
			
			<div class="projectActionList_Box" style="margin: 20px;width:100%;">
				<div id="projectActionList"  style='width:97%'></div>
			</div>
			
			
			<div class="blackbackground">
				<div style="background-color:rgba(102, 102, 102, 1);width:100%;height:44px;float: left;margin:20px 0px 20px 0px" >
					<div style="color: #FFFFFF;border-style:solid; border-width:10px; border-color:rgba(102, 102, 102, 1)" >
						<span >查看收款计划</span>
					</div>
				</div>
			</div>
			
			<div class="blackbackground">
				<div style="background-color:rgba(102, 102, 102, 1);width:100%;height:44px;float: left;margin:20px 0px 20px 0px " >
					<div style="color: #FFFFFF;border-style:solid; border-width:10px; border-color:rgba(102, 102, 102, 1)" >
						<span >查看审批记录</span>
					</div>
				</div>
			</div>
			
			<div>
				<c:forEach items="${projectApproveLogList}" var="r"> 
					<div class="line-borders" style="line-height: 50px;border-top: 1px solid #ccc;">
						<span  style=''>状态 ：</span>
						<span  style=''>
							<c:if test="${r.status == -1}">删除</c:if>
							<c:if test="${r.status == 0}">待审核 </c:if>
							<c:if test="${r.status == 1}">审核通过 </c:if>
							<c:if test="${r.status == 2}">审核不通过</c:if>
							<c:if test="${r.status == 3}">立项终止</c:if>
							<c:if test="${r.status == 4}">撤回</c:if>
						</span>
						<div  style=''>
							<span>操作人 ：</span>
							<span>${r.createrName}</span>
							<span style="margin-left:50px;">操作人ID：</span>
							<span>${r.createrAccount}</span>
						</div>
						<div  style=''>
							<span>时间：</span>
							<span ><fmt:formatDate value='${r.approveTime}' pattern='yyyy年MM月dd日   HH:mm:ss' /></span>
						 </div>
						<div  style=''>
							<span>意见 ：</span>
							<span>${r.remark}</span>
						</div>
					</div>	
				</c:forEach>
			</div>
			
			
			<div  style="text-align: center;">
				<div style="background-color: rgba(22, 155, 213, 1);display:inline-block;height: 40px;border-radius:5px;margin: 20px 0;" >
					<div style="visibility: visible;margin:10px 50px 10px 50px;color: #FFFFFF" onclick="window.history.go(-1)">
					<a href="javascript:;"  style="color: #FFFFFF">返回</a>
					</div>
				</div>
				
				<div style="background-color: rgba(22, 155, 213, 1);display:inline-block;height: 40px;border-radius:5px;margin:  20px 100px" >
					<div style="visibility: visible;margin:10px 50px 10px 50px">
						<a href="<%=basePath%>/project/list.html"  style="color: #FFFFFF">其他</a>
					</div>
				</div>
			</div>
			
			
		</div>
	</body>
</html>